<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Title and other stuffs -->
    <title>角色管理界面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="">
    <!-- Stylesheets -->
    <link href="bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet">
    <!-- Font awesome icon -->
    <link rel="stylesheet" href="style/font-awesome.min.css">
    <!-- bootstrap-treeview -->
    <link rel="stylesheet" href="style/css/bootstrap-treeview.css">
    <!-- jQuery UI -->
    <link rel="stylesheet" href="style/jquery-ui.css">
    <!-- Calendar -->
    <link rel="stylesheet" href="style/fullcalendar.css">
    <!-- prettyPhoto -->
    <link rel="stylesheet" href="style/prettyPhoto.css">
    <!-- Star rating -->
    <link rel="stylesheet" href="style/rateit.css">
    <!-- Date picker -->
    <link rel="stylesheet" href="style/bootstrap-datetimepicker.min.css">
    <!-- CLEditor -->
    <link rel="stylesheet" href="style/jquery.cleditor.css">
    <!-- Bootstrap toggle -->
    <link rel="stylesheet" href="style/bootstrap-switch.css">
    <!-- Main stylesheet -->
    <link href="style/style.css" rel="stylesheet">
    <!-- Widgets stylesheet -->
    <link href="style/widgets.css" rel="stylesheet">

    <!-- HTML5 Support for IE -->
    <!--[if lt IE 9]>
    <script src="js/html5shim.js"></script>
    <![endif]-->

    <!-- Favicon -->
    <link rel="shortcut icon" href="img/favicon/favicon.png">
</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

    <div class="conjtainer">
        <!-- Menu button for smallar screens -->
        <div class="navbar-header">
            <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse"
                    data-target=".bs-navbar-collapse">
                <span>Menu</span>
            </button>
            <!-- Site name for smallar screens -->
            <a href="index.html" class="navbar-brand hidden-lg">MacBeth</a>
        </div>


        <!-- Navigation starts -->
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

            <ul class="nav navbar-nav">

                <!-- Upload to server link. Class "dropdown-big" creates big dropdown -->
                <li class="dropdown dropdown-big">
                    <a href="#" class="dropdown-toggle" ><span class="label label-success"><i
                            class="icon-cloud-upload"></i></span> 后台管理系统</a>
                    <!-- Dropdown -->
                    <ul class="dropdown-menu">
                        <li>
                            <!-- Progress bar -->
                            <p>企业简介:无锡红光标牌有限公司是一家集研发、生产、销售和服务于一体的专业标牌生产厂家。注册资金500万人民币。主要生产塑料基材、软塑透明树脂、金属、模内复合等标牌产品，洗衣机顶盖板总成，平衡板，以及塑印、彩印、顶盖板、吸音垫等产品。公司位于长江三角洲经济快速增长、风景秀丽的太湖之畔——无锡。 公司自1984年成立至今，已经过了3次跨越式的发展。2004年至今公司投入5000多万元资金建设新的生产基地，目前已竣工并投入生产，占地面积达40000m2，厂房面积近15000m2。公司2004年的年产值达4350多万元，并且每年以平均30%的速度快速增长。目前，本公司的产品已具备国际及国内多项质量认证证书，并为知名家用电器企业：小天鹅电器有限公司、三星电子有限公司、海尔集团、惠尔普等配套生产各类标牌。可以说客户是我们的老师，和他们合作使我们得到很多的学习机会来提高自身的技术水平和管理水平，是我们生产和发展的动力。 公司本着“千方百计生产出满足顾客期望和要求的产品”的宗旨，坚持“工厂出产的不仅仅是产品，更重要的是信誉和质量”的经营理念，不断吸收新技术、引进新设备，使公司的经济效益蒸蒸日上。相信公司将会永不停止探索和发展的脚步，和中国国内以及世界国际性大公司同步发展。</p>


                            <hr/>


                        </li>
                    </ul>
                </li>


            </ul>


            <!-- Links -->
            <ul class="nav navbar-nav pull-right">
                <li class="dropdown pull-right">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <i class="icon-user"></i> Admin <b class="caret"></b>
                    </a>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu">
                        <li><a href="#"><i class="icon-user"></i> Profile</a></li>
                        <li><a href="#"><i class="icon-cogs"></i> Settings</a></li>
                        <li><a href="login.html"><i class="icon-off"></i> Logout</a></li>
                    </ul>
                </li>

            </ul>
        </nav>

    </div>
</div>


<!-- Header starts -->
<header>
    <div class="container">

    </div>
</header>

<!-- Header ends -->

<!-- Main content starts -->

<div class="content">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-dropdown"><a href="#">导航</a></div>

        <!--- Sidebar navigation -->
        <!-- If the main navigation has sub navigation, then add the class "has_sub" to "li" of main navigation. -->
        <ul id="nav">
            <!-- Main menu with font awesome icon -->
            <li><a href="index.html" class="open"><i class="icon-home"></i> 首页</a>
                <!-- Sub menu markup
                <ul>
                  <li><a href="#">Submenu #1</a></li>
                  <li><a href="#">Submenu #2</a></li>
                  <li><a href="#">Submenu #3</a></li>
                </ul>-->
            </li>
            <li class="has_sub"><a href="#"><i class="icon-list-alt"></i> 系统管理 <span class="pull-right"><i
                    class="icon-chevron-right"></i></span></a>
                <ul>
                    <li><a href="authorityMng.html">权限管理</a></li>
                    <li><a href="widgets2.html">菜单管理</a></li>
                    <li><a href="widgets2.html">账号管理</a></li>
                    <li><a href="roleMng.html">角色管理</a></li>
                </ul>
            </li>
            <li><a href="tables.html"><i class="icon-table"></i>表格</a></li>
            <li><a href="forms.html"><i class="icon-tasks"></i>表单</a></li>
        </ul>
    </div>

    <!-- Sidebar ends -->

    <!-- Main bar -->
    <div class="mainbar">
        <div class="matter">
            <div class="container">
                <div class="row">

                    <div class="col-md-12">
                        <div class="widget">
                            <div class="widget-head">
                                <div class="pull-left">查询</div>
                                <div class="widget-icons pull-right">
                                    <a href="#" class="wminimize"><i class="icon-chevron-up"></i></a>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget-content">
                                <div class="padd">

                                    <div class="form quick-post">
                                        <!-- Edit profile form (not working)-->
                                        <form class="form-horizontal">
                                            <!-- Title -->
                                            <div class="form-group">
                                                <label class="control-label col-lg-6" for="title">角色名称</label>
                                                <div class="col-lg-6">
                                                    <input type="text" class="form-control" id="title">
                                                </div>
                                                <div class="col-lg-3">
                                                    <button type="button" class="btn btn-success">搜索</button>
                                                    <!--<button type="button" class="btn btn-danger">新增</button>-->
                                                    <a href="#myModal" class="btn btn-info" data-toggle="modal">新增</a>
                                                </div>
                                            </div>
                                        </form>
                                    </div>


                                </div>
                                <div class="widget-foot">
                                    <!-- Footer goes here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">

                    <div class="col-md-12">
                        <div class="widget-content">

                            <table  class="table table-striped table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>角色ID</th>
                                    <th>角色名称</th>
                                    <th>角色描述</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="tb">

                                </tbody>
                            </table>

                            <div class="widget-foot">


                                <ul class="pagination pull-right">
                                    <li><a href="#">Prev</a></li>
                                    <li><a href="#">1</a></li>
                                    <li><a href="#">2</a></li>
                                    <li><a href="#">3</a></li>
                                    <li><a href="#">4</a></li>
                                    <li><a href="#">Next</a></li>
                                </ul>

                                <div class="clearfix"></div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matter ends -->

    </div>

    <!-- Mainbar ends -->
    <div class="clearfix"></div>
    <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">新增角色</h4>
                </div>
                <div class="modal-body">
                    <hr />
                    <!-- Form starts.  -->
                    <form class="form-horizontal" role="form" id="addForm">

                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色名称</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="名称" id="roleName">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色描述</label>
                            <div class="col-lg-8">
                                <textarea class="form-control" rows="3" placeholder="描述" id="roleDesc"></textarea>
                            </div>
                        </div>

                    </form>
                    <hr />
<!--
                        <div class="col-sm-12">
                            <br/>
                            <h4>权限设置</h4>
                            <div id="treeview1" class=""></div>
                        </div>-->
                    <hr />
                    <div class="col-sm-12">
                        <br/>
                        <br/>
                        <h4>权限</h4>
                        <div id="treeview-checkable"></div>
                    </div>
                    <hr />

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btn-check-all">获取选中的权限</button>

                    <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn-add-role">保存</button>
                </div>
            </div>
        </div>
    </div>



    <div id="updateModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"  style="height:600px" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" >
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">修改角色信息</h4>
                </div>
                <div class="modal-body" >
                    <hr />
                    <!-- Form starts.  -->
                    <form class="form-horizontal" role="form" id="updateForm">
                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色ID</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="ID" id="updateFormId" readonly="readonly">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色名称</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="名称" id="roleNameUpdate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色描述</label>
                            <div class="col-lg-8">
                                <textarea class="form-control" rows="3" placeholder="描述" id="roleDescUpdate"></textarea>
                            </div>
                        </div>

                    </form>
                    <hr />
                    <!--
                                            <div class="col-sm-12">
                                                <br/>
                                                <h4>权限设置</h4>
                                                <div id="treeview1" class=""></div>
                                            </div>-->
                    <hr />
                    <div class="col-sm-12">
                        <br/>
                        <br/>
                        <h4>权限</h4>
                        <div id="treeview-checkable-update"></div>
                    </div>
                    <hr />

                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn-update-role">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Content ends -->

<!-- Footer starts -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <!-- Copyright info -->
                <p class="copy">Copyright &copy; 2012 | <a href="#">Your Site</a></p>
            </div>
        </div>
    </div>
</footer>

<!-- Footer ends -->

<!-- Scroll to top -->
<span class="totop"><a href="#"><i class="icon-chevron-up"></i></a></span>

<!-- JS -->
<script src="js/jquery.js"></script> <!-- jQuery -->
<script src="bootstrap-3.3.7-dist/js/bootstrap.js"></script> <!-- Bootstrap -->- prettyPhoto -->
<script src="js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->
<script src="js/fullcalendar.min.js"></script> <!-- Full Google Calendar - Calendar -->
<script src="js/jquery.rateit.min.js"></script> <!-- RateIt - Star rating -->
<script src="js/jquery.prettyPhoto.js"></script> <!-- prettyPhoto -->

<!-- jQuery Flot -->
<script src="js/excanvas.min.js"></script>
<script src="js/jquery.flot.js"></script>
<script src="js/jquery.flot.resize.js"></script>
<script src="js/jquery.flot.pie.js"></script>
<script src="js/jquery.flot.stack.js"></script>

<!-- jQuery Notification - Noty -->
<script src="js/jquery.noty.js"></script> <!-- jQuery Notify -->
<script src="js/themes/default.js"></script> <!-- jQuery Notify -->
<script src="js/layouts/bottom.js"></script> <!-- jQuery Notify -->
<script src="js/layouts/topRight.js"></script> <!-- jQuery Notify -->
<script src="js/layouts/top.js"></script> <!-- jQuery Notify -->
<!-- jQuery Notification ends -->

<script src="js/sparklines.js"></script> <!-- Sparklines -->
<script src="js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
<script src="js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
<script src="js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->
<script src="js/filter.js"></script> <!-- Filter for support page -->
<script src="js/custom.js"></script> <!-- Custom codes -->
<script src="js/charts.js"></script> <!-- Charts & Graphs -->
<script src="js/bootstrap-treeview.js"></script> <!-- Bootstrap -->
<script>

    var $checkableTree;
    var $checkableTreeUpate;

    function getTree(){
        var defaultData = [
        ];
        $.ajax({
            //请求方式
            type : "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            async: false,
            //请求地址
            url : "http://127.0.0.1:8095/authority/getAuthorityTree",
            //数据，json字符串
//            data : list,
            //请求成功
            success : function(result) {
                console.log(result);

                var code = result.code;
                var msg = result.msg;
                if(code === 1000){

                    defaultData.push(result.data);
                    console.log(defaultData);

                }else{
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        });
        return defaultData;
    }
    function dataLoad() {
        document.getElementById("tb").innerHTML="";
        $.ajax({
            //请求方式
            type : "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url : "http://127.0.0.1:8095/role/findAll",
            //数据，json字符串
//            data : list,
            //请求成功
            success : function(result) {
                console.log(result);

                var code = result.code;
                var msg = result.msg;
                if(code === 1000){
                    var tableData = result.data;
                    var h="";
                    for(var i=0;i<tableData.length;i++) {
                        var dataObj = tableData[i];

                        console.log("id:"+ dataObj.id);
                        console.log("name:"+dataObj.name);
                        var id = dataObj.id;
                        var name = dataObj.name;

                        var num = i+1;
                        h += "<tr>";
                            h += "<td>" + id + "</td>";
                            h += "<td>" + name + "</td>";
                            h += "<td></td>";
                            h += "<td><a href=\"#updateModal\" class=\"btn btn-info\" data-toggle=\"modal\"  onclick=\"updateFormId("+id+")\">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;" +
                                "<button type=\"button\" class=\"btn btn-primary\">删除</button></td>";
                        h += "</tr>";
                    }

                document.getElementById("tb").innerHTML=h;
                }else{
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        });

    };

    function updateFormId(id){
        $checkableTreeUpate.treeview('uncheckAll', { silent: $('#chk-check-silent').is(':checked') });
        $("#roleNameUpdate").val('');
        $("#updateFormId").val('');
        $("#roleDescUpdate").val('');
        $("#btn-add-role").prop("disabled", false);
        $("#updateFormId").val(id);
        console.log(id);
        $.ajax({
            //请求方式
            type : "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url : "http://127.0.0.1:8095/role/find/"+id,
            //数据，json字符串
//            data : list,
            //请求成功
            success : function(result) {
                console.log(result);

                var code = result.code;
                var msg = result.msg;
                if(code === 1000){
                    var roleInfo = result.data;
                    var h="";

                        console.log("id:"+ roleInfo.id);
                        console.log("name:"+roleInfo.name);
                        var name = roleInfo.name;
                        $("#roleNameUpdate").val(name);
                        var authorityDTOS = roleInfo.authorityDTOS;
                        var rootNode = $checkableTreeUpate.treeview('getNode', 0);
                        ergodic(rootNode,authorityDTOS);


                }else{
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };

    function ergodic(rootNode,authorityDTOS){

        for(var i=0;i<authorityDTOS.length;i++){
            var tags = rootNode.tags;
            var authorityDto = authorityDTOS[i];
            var authority = authorityDto.authority;
            var tag = tags[0];
            if(authority === tag){
//                console.log("该节点需要check");
                $checkableTreeUpate.treeview('checkNode', [ rootNode.nodeId, { silent: true } ]);
                break;
            }else{
//                console.log("该节点不需要check");
            }
        }

        var childrenNodes =  getChildrenNodeIds(rootNode);
//        console.log(childrenNodes);
        for(var i=0;i<childrenNodes.length;i++){
            var nodeId = childrenNodes[i];
            var node = $checkableTreeUpate.treeview('getNode', nodeId);
            var tags = node.tags;

            var tag = tags[0];

            for(var j=0;j<authorityDTOS.length;j++){

                var authorityDto = authorityDTOS[j];
                var authority = authorityDto.authority;

                if(authority === tag){
//                    console.log("该节点需要check");
                    $checkableTreeUpate.treeview('checkNode', [ nodeId ]);
                    break;
                }else{
//                    console.log("该节点不需要check");
                }
            }

//            console.log(authority+","+tag);
//            if(authority === tag){
//                console.log("该节点需要check");
//                $checkableTreeUpate.treeview('checkNode', [ nodeId ]);
//            }else{
//                console.log("该节点不需要check");
//            }
        }

    }

    function getChildrenNodeIds(node) {
        var ts = [];
        if(node.nodes) {
            for(x in node.nodes) {
                ts.push(node.nodes[x].nodeId);
                if(node.nodes[x].nodes) {
                    var getNodeDieDai = getChildrenNodeIds(node.nodes[x]);//有第二层，第三层子节点的情况
                    for(j in getNodeDieDai) {
                        ts.push(getNodeDieDai[j]);
                    }
                }
            }
        } else {
            ts.push(node.nodeId);
        }
        return ts;
    };

    $(function(){
        //todo 加载角色数据
        dataLoad();
        //todo 初始化权限树

        $checkableTreeUpate = $('#treeview-checkable-update').treeview({
            data: getTree(),
            showIcon: false,
            showCheckbox: true,
            multiSelect:false,
            onNodeChecked: function(event, node) {
//                $('#checkable-output').prepend('<p>' + node.text + ' was checked</p>');
                var selectNodes= getChildNodeIdArr(node);//获取所有节点
                if(selectNodes){//如果子节点不为空，即存在子节点，则选中所有子节点
                    //选择指定的节点，接收节点或节点ID
                    $checkableTreeUpate.treeview('checkNode',[selectNodes,{silent:true}])
                }
                //返回给定节点ID的单一节点对象
                setParentNodeCheckUpdate(node);
            },
            onNodeUnchecked: function (event, node) {
//                $('#checkable-output').prepend('<p>' + node.text + ' was unchecked</p>');
                var selectNodes=getChildNodeIdArr(node);
                if(selectNodes){//子节点不为空，则取消选中所有子节点
                    $checkableTreeUpate.treeview("uncheckNode",[selectNodes,{silent:true}]);
                }
                if(node.parentId!==undefined) {
                    var parentNode = $checkableTreeUpate.treeview("getNode", node.parentId);
                    var uncheckNodes = getParentNodeIdArrUpdate(parentNode);

                    console.info(uncheckNodes);
                    for (var idx = 0; idx < uncheckNodes.length; idx++) {
                        var nodeId = uncheckNodes[idx];
                        var uncheckNode = $checkableTreeUpate.treeview('getNode', nodeId);
                        if (uncheckNode.state.checked === true) {
                            $checkableTreeUpate.treeview('uncheckNode', [uncheckNode, {silent: true}])
                        }
                    }
                }

            }
        });
        $checkableTreeUpate.treeview('expandAll', { levels: 2, silent: true });
        $checkableTree = $('#treeview-checkable').treeview({
            data: getTree(),
            showIcon: false,
            showCheckbox: true,
            multiSelect:false,
            onNodeChecked: function(event, node) {
//                $('#checkable-output').prepend('<p>' + node.text + ' was checked</p>');
                var selectNodes= getChildNodeIdArr(node);//获取所有节点
                if(selectNodes){//如果子节点不为空，即存在子节点，则选中所有子节点
                    //选择指定的节点，接收节点或节点ID
                    $checkableTree.treeview('checkNode',[selectNodes,{silent:true}])
                }
                //返回给定节点ID的单一节点对象
                setParentNodeCheck(node);
            },
            onNodeUnchecked: function (event, node) {
//                $('#checkable-output').prepend('<p>' + node.text + ' was unchecked</p>');
                var selectNodes=getChildNodeIdArr(node);
                if(selectNodes){//子节点不为空，则取消选中所有子节点
                    $checkableTree.treeview("uncheckNode",[selectNodes,{silent:true}]);
                }
                if(node.parentId!==undefined) {
                    var parentNode = $checkableTree.treeview("getNode", node.parentId);
                    var uncheckNodes = getParentNodeIdArr(parentNode);

                    console.info(uncheckNodes);
                    for (var idx = 0; idx < uncheckNodes.length; idx++) {
                        var nodeId = uncheckNodes[idx];
                        var uncheckNode = $checkableTree.treeview('getNode', nodeId);
                        if (uncheckNode.state.checked === true) {
                            $checkableTree.treeview('uncheckNode', [uncheckNode, {silent: true}])
                        }
                    }
                }

            }
        });

        var getChildNodeIdArr = function(node) {
            var ts = [];
            if(node.nodes) {
                for(x in node.nodes) {
                    ts.push(node.nodes[x].nodeId);
                    if(node.nodes[x].nodes) {
                        var getNodeDieDai = getChildNodeIdArr(node.nodes[x]);//有第二层，第三层子节点的情况
                        for(j in getNodeDieDai) {
                            ts.push(getNodeDieDai[j]);
                        }
                    }
                }
            } else {
                ts.push(node.nodeId);
            }
            return ts;
        };
        var getParentNodeIdArrUpdate = function(node) {
            console.info(node);
            var ts = [];
            ts.push(node.nodeId);
            if(node.nodeId!==0){
                var parentNode = $checkableTreeUpate.treeview("getNode", node.parentId);
                var getNodeDieDai = getParentNodeIdArr(parentNode);
                for(j in getNodeDieDai) {
                    ts.push(getNodeDieDai[j]);
                }
            }
            return ts;
        };
        var getParentNodeIdArr = function(node) {
            console.info(node);
            var ts = [];
            ts.push(node.nodeId);
            if(node.nodeId!==0){
                var parentNode = $checkableTree.treeview("getNode", node.parentId);
                var getNodeDieDai = getParentNodeIdArr(parentNode);
                for(j in getNodeDieDai) {
                    ts.push(getNodeDieDai[j]);
                }
            }
            return ts;
        };
        var setParentNodeCheckUpdate = function(node) {
            var parentNode = $checkableTreeUpate.treeview("getNode", node.parentId);
            if(parentNode.nodes) {
                var checkedCount = 0;
                for(x in parentNode.nodes) {
                    if(parentNode.nodes[x].state.checked) {
                        checkedCount++;
                    } else {
                        break;
                    }
                }
                if(checkedCount === parentNode.nodes.length) {
                    $checkableTreeUpate.treeview("checkNode", parentNode.nodeId);
                    setParentNodeCheck(parentNode);
                }
            }
        };
        var setParentNodeCheck = function(node) {
            var parentNode = $checkableTree.treeview("getNode", node.parentId);
            if(parentNode.nodes) {
                var checkedCount = 0;
                for(x in parentNode.nodes) {
                    if(parentNode.nodes[x].state.checked) {
                        checkedCount++;
                    } else {
                        break;
                    }
                }
                if(checkedCount === parentNode.nodes.length) {
                    $checkableTree.treeview("checkNode", parentNode.nodeId);
                    setParentNodeCheck(parentNode);
                }
            }
        };
        var findCheckableNodes = function() {
            return $checkableTree.treeview('search', [ $('#input-check-node').val(), { ignoreCase: false, exactMatch: false } ]);
        };
        var checkableNodes = findCheckableNodes();


        var findParentNode = function (node) {
            return $checkableTree.treeview('getParent', node);
        };

        var checkedNodes = function(){
            return $checkableTree.treeview('getChecked');
        };
        $('#btn-check-all').on('click', function (e) {
            var checkedTags = checkedNodesTags();
            console.log(checkedTags);
        });
        //todo 获取复选框选中的权限tags
        var checkedNodesTags = function(){
            var tags = [];
            var nodes = $checkableTree.treeview('getChecked');
            if(nodes&&nodes.length>0){
                for (var idx = 0; idx < nodes.length; idx++) {
                    var node = nodes[idx];
                    var tag = node.tags;
                    tags.push(tag[0]);
                }

            }else{
                alert("请选择角色权限");
            }
            return tags;
        };
        //todo 添加角色
        var addRole = function (){
            var roleName = $("#roleName").val();
            var roleDesc = $("#roleDesc").val();
            var checkedTags = checkedNodesTags();
            var checkedTagsStr = checkedTags.join(",");
            $.ajax({
                //请求方式
                type : "POST",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url : "http://127.0.0.1:8095/role/add",
                //数据，json字符串
                data : {
                    roleName:roleName,
                    roleDesc:roleDesc,
                    checkedTags:checkedTagsStr
                },
                //请求成功
                success : function(result) {
                    console.log(result);

                    var code = result.code;
                    var msg = result.msg;
                    if(code === 1000){
                        alert('操作成功');
                        dataLoad();
                        $("#myModal").modal('hide');
                    }else{
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error : function(e){
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };


//        $("#myModal1").modal('show');  //手动开启

//        $("#myModal1").modal('hide');  //手动关闭
        //todo 点击添加角色按钮
        $('#btn-add-role').on('click',function (e) {
            $('#btn-add-role').prop('disabled', true);
            addRole();
        });

        //todo 添加角色框监听打开关闭时间
        $('#myModal').on('show.bs.modal', function () {
            $checkableTree.treeview('uncheckAll', { silent: $('#chk-check-silent').is(':checked') });
            $("#roleName").val('');
            $("#roleDesc").val('');
            $('#btn-add-role').prop('disabled', false);
        });

        $('#myModal').on('hidden.bs.modal', function () {
//          console.log("模态框关闭");
            $checkableTree.treeview('uncheckAll', { silent: $('#chk-check-silent').is(':checked') });
            $("#roleName").val('');
            $("#roleDesc").val('');
        });


        /*
                $('#btn-check-node.check-node').on('click', function (e) {
                    $checkableTree.treeview('checkNode', [ checkableNodes, { silent: $('#chk-check-silent').is(':checked') }]);
                });

                $('#btn-uncheck-node.check-node').on('click', function (e) {
                    $checkableTree.treeview('uncheckNode', [ checkableNodes, { silent: $('#chk-check-silent').is(':checked') }]);
                });

                $('#btn-toggle-checked.check-node').on('click', function (e) {
                    $checkableTree.treeview('toggleNodeChecked', [ checkableNodes, { silent: $('#chk-check-silent').is(':checked') }]);
                });

                // Check/uncheck all
                $('#btn-check-all').on('click', function (e) {
                    $checkableTree.treeview('checkAll', { silent: $('#chk-check-silent').is(':checked') });
                });

                $('#btn-uncheck-all').on('click', function (e) {
                    $checkableTree.treeview('uncheckAll', { silent: $('#chk-check-silent').is(':checked') });
                });*/

    });
</script>
</body>
</html>