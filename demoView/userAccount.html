<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Title and other stuffs -->
    <title>账号管理界面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="">


    <!-- Stylesheets -->
    <link href="../bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet">
    <!-- Font awesome icon -->
    <link rel="stylesheet" href="../style/font-awesome.min.css">
    <!-- bootstrap-treeview -->
    <link rel="stylesheet" href="../style/css/bootstrap-treeview.css">
    <!-- jQuery UI -->
    <link rel="stylesheet" href="../style/jquery-ui.css">
    <!-- Calendar -->
    <link rel="stylesheet" href="../style/fullcalendar.css">
    <!-- prettyPhoto -->
    <link rel="stylesheet" href="../style/prettyPhoto.css">
    <!-- Star rating -->
    <link rel="stylesheet" href="../style/rateit.css">
    <!-- Date picker -->
    <link rel="stylesheet" href="../style/bootstrap-datetimepicker.min.css">
    <!-- CLEditor -->
    <link rel="stylesheet" href="../style/jquery.cleditor.css">
    <!-- Bootstrap toggle -->
    <link rel="stylesheet" href="../style/bootstrap-switch.css">
    <!-- Main stylesheet -->
    <link href="../style/style.css" rel="stylesheet">
    <!-- Widgets stylesheet -->
    <link href="../style/widgets.css" rel="stylesheet">


    <!-- combobox -->
    <link href="../style/css/bootstrap-combobox.css" rel="stylesheet">

    <!-- HTML5 Support for IE -->
    <!--[if lt IE 9]>
    <script src="../js/html5shim.js"></script>
    <![endif]-->

</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

    <div class="conjtainer">
        <!-- Menu button for smallar screens -->
        <div class="navbar-header">
            <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse"
                    data-target=".bs-navbar-collapse">
                <span>Menu</span>
            </button>
            <!-- Site name for smallar screens -->
            <a href="../index.html" class="navbar-brand hidden-lg">MacBeth</a>
        </div>


        <!-- Navigation starts -->
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

            <ul class="nav navbar-nav">

                <!-- Upload to server link. Class "dropdown-big" creates big dropdown -->
                <li class="dropdown dropdown-big">
                    <a href="#" class="dropdown-toggle"><span class="label label-success"><i
                            class="icon-cloud-upload"></i></span> 后台管理系统</a>
                    <!-- Dropdown -->
                    <ul class="dropdown-menu">
                        <li>
                            <!-- Progress bar -->
                            <p>
                                企业简介:无锡红光标牌有限公司是一家集研发、生产、销售和服务于一体的专业标牌生产厂家。注册资金500万人民币。主要生产塑料基材、软塑透明树脂、金属、模内复合等标牌产品，洗衣机顶盖板总成，平衡板，以及塑印、彩印、顶盖板、吸音垫等产品。公司位于长江三角洲经济快速增长、风景秀丽的太湖之畔——无锡。
                                公司自1984年成立至今，已经过了3次跨越式的发展。2004年至今公司投入5000多万元资金建设新的生产基地，目前已竣工并投入生产，占地面积达40000m2，厂房面积近15000m2。公司2004年的年产值达4350多万元，并且每年以平均30%的速度快速增长。目前，本公司的产品已具备国际及国内多项质量认证证书，并为知名家用电器企业：小天鹅电器有限公司、三星电子有限公司、海尔集团、惠尔普等配套生产各类标牌。可以说客户是我们的老师，和他们合作使我们得到很多的学习机会来提高自身的技术水平和管理水平，是我们生产和发展的动力。
                                公司本着“千方百计生产出满足顾客期望和要求的产品”的宗旨，坚持“工厂出产的不仅仅是产品，更重要的是信誉和质量”的经营理念，不断吸收新技术、引进新设备，使公司的经济效益蒸蒸日上。相信公司将会永不停止探索和发展的脚步，和中国国内以及世界国际性大公司同步发展。</p>


                            <hr/>


                        </li>
                    </ul>
                </li>


            </ul>


            <!-- Links -->
            <ul class="nav navbar-nav pull-right">
                <li class="dropdown pull-right">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <i class="icon-user"></i> Admin <b class="caret"></b>
                    </a>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu">
                        <li><a href="#"><i class="icon-user"></i> Profile</a></li>
                        <li><a href="#"><i class="icon-cogs"></i> Settings</a></li>
                        <li><a href="login.html"><i class="icon-off"></i> Logout</a></li>
                    </ul>
                </li>

            </ul>
        </nav>

    </div>
</div>

<header>
    <div class="container">

    </div>
</header>
<!-- Main content starts -->

<div class="content">

    <!--todo 菜单部分 -->
    <div class="sidebar">
        <div class="sidebar-dropdown"><a href="#">导航</a></div>

        <!--- Sidebar navigation -->
        <!-- If the main navigation has sub navigation, then add the class "has_sub" to "li" of main navigation. -->
        <ul id="nav">
            <!-- Main menu with font awesome icon -->
            <!--<li><a href="../index.html" class="open"><i class="icon-home"></i> 首页</a> -->
               <!-- Sub menu markup
               <ul>
                 <li><a href="#">Submenu #1</a></li>
                 <li><a href="#">Submenu #2</a></li>
                 <li><a href="#">Submenu #3</a></li>
               </ul>-->
            <!--  </li>-->
            <!--  <li class="has_sub"><a href="#"><i class="icon-list-alt"></i> 系统管理 <span class="pull-right"><i
                 class="icon-chevron-right"></i></span></a>
             <ul>
                 <li><a href="authorityMng.html">权限管理</a></li>
                 <li><a href="menuMng.html">菜单管理</a></li>
                 <li><a href="userAccount.html">账号管理</a></li>
                 <li><a href="roleMng.html">角色管理</a></li>
             </ul>
         </li>
         <li><a href="../tables.html"><i class="icon-table"></i>表格</a></li>
         <li><a href="../forms.html"><i class="icon-tasks"></i>表单</a></li>-->
     </ul>
 </div>
 <!-- 菜单部分 ends -->

    <!--todo 查询表单和数据列表 -->
    <div class="mainbar">
        <div class="matter">
            <div class="container">
                <!--todo 查询表单 -->
                <div class="row">

                    <div class="col-md-12">
                        <div class="widget">
                            <div class="widget-head">
                                <div class="pull-left">查询</div>
                                <div class="widget-icons pull-right">
                                    <a href="#" class="wminimize"><i class="icon-chevron-up"></i></a>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget-content">
                                <div class="padd">

                                    <div class="form quick-post">
                                        <!-- Edit profile form (not working)-->
                                        <form class="form-horizontal" id="queryForm">
                                            <!-- Title -->
                                            <div class="form-group">
                                                <label class="control-label col-lg-6" for="queryName">用户名</label>
                                                <div class="col-lg-3">
                                                    <input type="text" class="form-control" id="queryName">
                                                </div>
                                                <label class="control-label col-lg-6" for="queryUserName">账号</label>
                                                <div class="col-lg-3">
                                                    <input type="text" class="form-control" id="queryUserName">
                                                </div>
                                                <div class="col-lg-3">
                                                    <button type="button" class="btn btn-success" id="btn-query">搜索
                                                    </button>
                                                    <!--<button type="button" class="btn btn-danger">新增</button>-->
                                                    <a href="#myModal" class="btn btn-info" data-toggle="modal">新增</a>
                                                </div>
                                            </div>
                                        </form>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--todo 数据表格 -->
                <div class="row">

                    <div class="col-md-12">
                        <div class="widget-content">

                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>账号ID</th>
                                    <th>用户姓名</th>
                                    <th>账号</th>
                                    <th>角色</th>
                                    <th>邮箱</th>
                                    <th>创建日期</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="tb">

                                </tbody>
                            </table>

                            <div class="widget-foot">


                                <ul class="pagination pull-right" id="paginationComponent">

                                </ul>

                                <div class="clearfix"></div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 查询表单和数据列表 ends -->

    <div class="clearfix"></div>
    <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">编辑窗口</h4>
                </div>
                <div class="modal-body">
                    <hr/>
                    <!-- Form starts.  -->
                    <form class="form-horizontal" role="form" id="userForm">
                        <div class="form-group">
                            <label class="col-lg-4 control-label">用户ID</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="用户ID" id="id" readonly="readonly">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">用户姓名</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="名称" id="name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">账号</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="账号" id="username">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">邮箱</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="邮箱" id="email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">角色</label>
                            <div class="col-lg-8">
                            <select class="combobox input-large form-control" style="display: none;" id="roleSelect">
                            </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">备注</label>
                            <div class="col-lg-8">
                                <textarea class="form-control" rows="3" placeholder="描述" id="describe"></textarea>
                            </div>
                        </div>

                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="btn-test">测试</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn-save">保存</button>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- Content ends -->



<!-- JS -->
<script src="../js/jquery.js"></script> <!-- jQuery -->
<script src="../bootstrap-3.3.7-dist/js/bootstrap.js"></script> <!-- Bootstrap -->
<script src="../js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->


<script src="../js/fullcalendar.min.js"></script> <!-- Full Google Calendar - Calendar -->
<script src="../js/jquery.prettyPhoto.js"></script> <!-- prettyPhoto -->
<!-- jQuery Notification ends -->

<script src="../js/sparklines.js"></script> <!-- Sparklines -->
<script src="../js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
<script src="../js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
<script src="../js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->
<script src="../js/filter.js"></script> <!-- Filter for support page -->
<script src="../js/custom.js"></script> <!-- Custom codes -->
<script src="../js/charts.js"></script> <!-- Charts & Graphs -->


<!-- JS -->
<script src="../js/bootstrap-combobox.js"></script> <!-- Bootstrap -->

<script src="../js/util/pagenationJs.js"></script> <!-- Bootstrap -->

<script src="../js/util/menuJs.js"></script> <!-- menuJs -->
<script>

    var pageNum = 1;
    var pageSize = 10;
    var $paginationComponent;
    var $menuComponent;
    function dataLoad(q) {


        var url = "http://127.0.0.1:8095/user/query";
        if (q !== '') {
            url += '?' + q;
        }

        document.getElementById("tb").innerHTML = "";
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: url,
            //数据，json字符串
            data: {
                pageSize: pageSize,
                pageNum: pageNum
            },
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var tableData = result.data;
                    var h = "";
                    for (var i = 0; i < tableData.length; i++) {
                        var dataObj = tableData[i];

                        var id = dataObj.id;
                        var name = dataObj.name;
                        var username = dataObj.username;
                        var email = dataObj.email;
                        var roleName = dataObj.roleName;
                        var createDateStr = dataObj.createDateStr;

                        h += "<tr>";
                        h += "<td>" + id + "</td>";
                        h += "<td>" + name + "</td>";
                        h += "<td>" + username + "</td>";
                        h += "<td>" + roleName + "</td>";
                        h += "<td>" + email + "</td>";
                        h += "<td>" + createDateStr + "</td>";
                        h += "<td><a href=\"#updateModal\" class=\"btn btn-info\" data-toggle=\"modal\"  onclick=\"getSysUser(" + id + ")\">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;" +
                            "<button type=\"button\" class=\"btn btn-primary\" onclick=\"deleteUser(" + id + ")\" >删除</button></td>";
                        h += "</tr>";
                    }

                    document.getElementById("tb").innerHTML = h;
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };

    function deleteUser(id) {
        $.ajax({
            //请求方式
            type: "PUT",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            async: false,
            //请求地址
            url: "http://127.0.0.1:8095/user/delete",
            //数据，json字符串
            data: {
                userId: id
            },
            //请求成功
            success: function (result) {


                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    alert('操作成功');
                    dataLoad('');
                    $paginationComponent.reload()
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };

    function getSysUser(id) {
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: "http://127.0.0.1:8095/user/find/" + id,
            //数据，json字符串
//            data : list,
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var userInfo = result.data;
                    var id = userInfo.id;
                    var name = userInfo.name;
                    var username = userInfo.username;
                    var description = userInfo.description;
                    var email = userInfo.email;
                    var roleName = userInfo.roleName;
                    var roleId = userInfo.roleId;

                    $("#name").val(name);
                    $("#id").val(id);
                    $("#username").val(username);
                    $("#email").val(email);
                    $("#describe").val(description);
                    roleComboboxSetValue(roleId);
                    console.log("roleId:"+roleId);
                    //todo 很麻烦的bootstrap select 赋初值

                    $("#myModal").modal('show');

                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };


    function getRoleList() {


        var url = "http://127.0.0.1:8095/role/findAll";
        document.getElementById("roleSelect").innerHTML = "";
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: url,
            async: false,
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var tableData = result.data;
                    var h = "<option value='' selected='selected'></option>";

                    for (var i = 0; i < tableData.length; i++) {
                        var dataObj = tableData[i];

                        var id = dataObj.id;
                        var name = dataObj.name;

                        h += "<option value='"+id+"' >"+name+"("+id+")"+"</option>";
                    }

                    document.getElementById("roleSelect").innerHTML = h;
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };


    function roleComboboxSetValue(roleId){
        $("#roleSelect option").each(function () {
            var val = $(this).val();
            var text = $(this).text();
            $(this).removeAttr('selected',"selected");
//                        console.log(val+"    --------       "+text);
            if(val == roleId){
                $(this).attr('selected',"selected");
                $("#roleSelectTextBox").val(text);
            }
        });
    }

    $(function () {
        //todo 初始化分页组件
        $paginationComponent = new page(
            {
                id: 'paginationComponent',
                nowNum: 1,
                allNumUrl: "http://127.0.0.1:8095/user/totalPage",
                isParam: false,
                pageSize: pageSize,
                dataMethod: 'dataLoad',
                queryForm: ['queryName', 'queryUserName'],
                callback: function (now, all) {
                    pageNum = now;
                }
            }
        );
        //todo 初始化菜单组件
        $menuComponent = new menu(
            {
                id:'nav',
                currentMenuName: '账号管理'
            }
        );
        //todo 加载角色数据
        dataLoad('');

        //todo 定义添加账号功能
        var add = function () {
            var name = $("#name").val();
            var username = $("#username").val();
            var email = $("#email").val();
            var describe = $("#describe").val();
            var roleSelect = $("#roleSelect").val();
            if(roleSelect===""||roleSelect===null){
                alert("请选择角色，角色不能为空！");
                return;
            }
            console.log("roleSelect:"+roleSelect);
            $.ajax({
                //请求方式
                type: "POST",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/user/add",
                //数据，json字符串
                data: {
                    name: name,
                    username: username,
                    email: email,
                    describe: describe,
                    roleId: roleSelect
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $paginationComponent.reload();
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };
        var update = function () {

            var id = $("#id").val();
            var name = $("#name").val();
            var username = $("#username").val();
            var email = $("#email").val();
            var describe = $("#describe").val();
            var roleSelect = $("#roleSelect").val();
            $.ajax({
                //请求方式
                type: "PUT",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/user/put",
                //数据，json字符串
                data: {
                    id: id,
                    name: name,
                    username: username,
                    email: email,
                    describe: describe,
                    roleId: roleSelect
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };

        //todo 点击保存账号按钮
        $('#btn-save').on('click', function (e) {
            $('#btn-save').prop('disabled', false);
            var id = $("#id").val();
            if(id === null||id ===''){
                add();
            }else{
                update();
            }
        });
        //todo 搜索按钮
        $("#btn-query").on('click', function (e) {
            var queryUserName = $("#queryUserName").val();
            var queryName = $("#queryName").val();

            var timestamp = Date.parse(new Date());
            var q = "ts=" + timestamp;

            if (queryUserName !== '' && queryUserName !== null){
                q += "&queryUserName=" + queryUserName;
            }
            if (queryName !== '' && queryName !== null){
                q += "&queryName=" + queryName;
            }

            if ((queryUserName === '' || queryUserName === null)&&(queryName === ''|| queryName === null)) {
                $paginationComponent.init(false);
            } else {
                $paginationComponent.init(true);
            }

//            initPagination(q);
            dataLoad(q);
        });

        //todo 界面调试按钮,测试辅助
        $("#btn-test").on('click',function (e){
            var roleSelect = $("#roleSelect").val();
            alert(roleSelect);
        });

        //todo 添加角色框监听打开关闭时间
        $('#myModal').on('show.bs.modal', function () {
            $('#btn-save').prop('disabled', false);
        });

        $('#myModal').on('hidden.bs.modal', function () {
//          console.log("模态框关闭");
            $("#name").val('');
            $("#id").val('');
            $("#username").val('');
            $("#email").val('');
            $("#describe").val('');
            roleComboboxSetValue('');
        });

        //todo 获取下拉框数据（角色列表）
        getRoleList();
        //todo 初始化下拉框
        $('#roleSelect').combobox({bsVersion: '3',textId: 'roleSelectTextBox'});
    });

</script>
</body>
</html>