<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <!-- Title and other stuffs -->
    <title>菜单管理界面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="">
    <!-- Stylesheets -->
    <link href="../bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet">
    <!-- Font awesome icon -->
    <link rel="stylesheet" href="../style/font-awesome.min.css">
    <!-- bootstrap-treeview -->
    <link rel="stylesheet" href="../style/css/bootstrap-treeview.css">
    <!-- jQuery UI -->
    <link rel="stylesheet" href="../style/jquery-ui.css">

    <!-- Main stylesheet -->
    <link href="../style/style.css" rel="stylesheet">
    <!-- Widgets stylesheet -->
    <link href="../style/widgets.css" rel="stylesheet">

    <!-- combobox -->
    <link href="../style/css/bootstrap-combobox.css" rel="stylesheet">

    <!-- HTML5 Support for IE -->
    <!--[if lt IE 9]>
    <script src="../js/html5shim.js"></script>
    <![endif]-->

</head>

<body>

<div class="navbar navbar-fixed-top bs-docs-nav" role="banner">

    <div class="conjtainer">
        <!-- Menu button for smallar screens -->
        <div class="navbar-header">
            <button class="navbar-toggle btn-navbar" type="button" data-toggle="collapse"
                    data-target=".bs-navbar-collapse">
                <span>Menu</span>
            </button>
            <!-- Site name for smallar screens -->
            <a href="../index.html" class="navbar-brand hidden-lg">MacBeth</a>
        </div>


        <!-- Navigation starts -->
        <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">

            <ul class="nav navbar-nav">

                <!-- Upload to server link. Class "dropdown-big" creates big dropdown -->
                <li class="dropdown dropdown-big">
                    <a href="#" class="dropdown-toggle"><span class="label label-success"><i
                            class="icon-cloud-upload"></i></span> 后台管理系统</a>
                    <!-- Dropdown -->
                    <ul class="dropdown-menu">
                        <li>
                            <!-- Progress bar -->
                            <p>
                                企业简介:无锡红光标牌有限公司是一家集研发、生产、销售和服务于一体的专业标牌生产厂家。注册资金500万人民币。主要生产塑料基材、软塑透明树脂、金属、模内复合等标牌产品，洗衣机顶盖板总成，平衡板，以及塑印、彩印、顶盖板、吸音垫等产品。公司位于长江三角洲经济快速增长、风景秀丽的太湖之畔——无锡。
                                公司自1984年成立至今，已经过了3次跨越式的发展。2004年至今公司投入5000多万元资金建设新的生产基地，目前已竣工并投入生产，占地面积达40000m2，厂房面积近15000m2。公司2004年的年产值达4350多万元，并且每年以平均30%的速度快速增长。目前，本公司的产品已具备国际及国内多项质量认证证书，并为知名家用电器企业：小天鹅电器有限公司、三星电子有限公司、海尔集团、惠尔普等配套生产各类标牌。可以说客户是我们的老师，和他们合作使我们得到很多的学习机会来提高自身的技术水平和管理水平，是我们生产和发展的动力。
                                公司本着“千方百计生产出满足顾客期望和要求的产品”的宗旨，坚持“工厂出产的不仅仅是产品，更重要的是信誉和质量”的经营理念，不断吸收新技术、引进新设备，使公司的经济效益蒸蒸日上。相信公司将会永不停止探索和发展的脚步，和中国国内以及世界国际性大公司同步发展。</p>


                            <hr/>


                        </li>
                    </ul>
                </li>


            </ul>


            <!-- Links -->
            <ul class="nav navbar-nav pull-right">
                <li class="dropdown pull-right">
                    <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <i class="icon-user"></i> Admin <b class="caret"></b>
                    </a>

                    <!-- Dropdown menu -->
                    <ul class="dropdown-menu">
                        <li><a href="#"><i class="icon-user"></i> Profile</a></li>
                        <li><a href="#"><i class="icon-cogs"></i> Settings</a></li>
                        <li><a href="login.html"><i class="icon-off"></i> Logout</a></li>
                    </ul>
                </li>

            </ul>
        </nav>

    </div>
</div>

<header>
    <div class="container">

    </div>
</header>
<!-- Main content starts -->

<div class="content">

    <!--todo 菜单部分 -->
    <div class="sidebar">
        <div class="sidebar-dropdown"><a href="#">导航</a></div>

        <!--- Sidebar navigation -->
        <!-- If the main navigation has sub navigation, then add the class "has_sub" to "li" of main navigation. -->
        <ul id="nav">
            <!-- Main menu with font awesome icon -->
            <li><a href="../index.html" class="open"><i class="icon-home"></i> 首页</a>
                <!-- Sub menu markup
                <ul>
                  <li><a href="#">Submenu #1</a></li>
                  <li><a href="#">Submenu #2</a></li>
                  <li><a href="#">Submenu #3</a></li>
                </ul>-->
            </li>
            <li class="has_sub"><a href="#"><i class="icon-list-alt"></i> 系统管理 <span class="pull-right"><i
                    class="icon-chevron-right"></i></span></a>
                <ul>
                    <li><a href="authorityMng.html">权限管理</a></li>
                    <li><a href="menuMng.html">菜单管理</a></li>
                    <li><a href="userAccount.html">账号管理</a></li>
                    <li><a href="roleMng.html">角色管理</a></li>
                </ul>
            </li>
            <li><a href="../tables.html"><i class="icon-table"></i>表格</a></li>
            <li><a href="../forms.html"><i class="icon-tasks"></i>表单</a></li>
        </ul>
    </div>
    <!-- 菜单部分 ends -->

    <!--todo 查询表单和数据列表 -->
    <div class="mainbar">
        <div class="matter">
            <div class="container">
                <!--todo 查询表单 -->
                <div class="row">

                    <div class="col-md-12">
                        <div class="widget">
                            <div class="widget-head">
                                <div class="pull-left">查询</div>
                                <div class="widget-icons pull-right">
                                    <a href="#" class="wminimize"><i class="icon-chevron-up"></i></a>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="widget-content">
                                <div class="padd">

                                    <div class="form quick-post">
                                        <!-- Edit profile form (not working)-->
                                        <form class="form-horizontal" id="queryForm">
                                            <!-- Title -->
                                            <div class="form-group">
                                                <label class="control-label col-lg-6" for="queryGroupName">分组名</label>
                                                <div class="col-lg-3">
                                                    <input type="text" class="form-control" id="queryGroupName">
                                                </div>
                                                <label class="control-label col-lg-6" for="queryMenuName">菜单名</label>
                                                <div class="col-lg-3">
                                                    <input type="text" class="form-control" id="queryMenuName">
                                                </div>
                                                <div class="col-lg-3">
                                                    <button type="button" class="btn btn-success" id="btn-query">搜索
                                                    </button>
                                                    <!--<button type="button" class="btn btn-danger">新增</button>-->
                                                    <a href="#myModal" class="btn btn-info" data-toggle="modal">新增</a>
                                                </div>
                                            </div>
                                        </form>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--todo 数据表格 -->
                <div class="row">

                    <div class="col-md-12">
                        <div class="widget-content">

                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                <tr>
                                    <th>菜单ID</th>
                                    <th>分组名</th>
                                    <th>菜单名</th>
                                    <th>链接</th>
                                    <th>创建日期</th>
                                    <th>排序</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="tb">

                                </tbody>
                            </table>

                            <div class="widget-foot">


                                <ul class="pagination pull-right" id="paginationComponent">

                                </ul>

                                <div class="clearfix"></div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 查询表单和数据列表 ends -->

    <div class="clearfix"></div>
    <div id="myModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">编辑窗口</h4>
                </div>
                <div class="modal-body">
                    <hr/>
                    <!-- Form starts.  -->
                    <form class="form-horizontal" role="form" id="userForm">
                        <div class="form-group">
                            <label class="col-lg-4 control-label">类型</label>
                            <div class="col-lg-8">
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="menuType" id="groupRadio" value="group" checked>
                                        分组
                                    </label>

                                    <label>
                                        <input type="radio" name="menuType" id="menuRadio" value="menu">
                                        菜单
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">菜单ID</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="菜单ID" id="id" readonly="readonly">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">分组名称</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="分组名称" id="groupName">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">菜单名称</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="菜单名称" id="menuName">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">菜单链接</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="菜单链接" id="menuHref">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">排序</label>
                            <div class="col-lg-8">
                                <input type="text" class="form-control" placeholder="排序" id="sort">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-lg-4 control-label">备注</label>
                            <div class="col-lg-8">
                                <textarea class="form-control" rows="3" placeholder="备注" id="description"></textarea>
                            </div>
                        </div>

                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="btn-test">测试</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</button>
                    <button type="button" class="btn btn-primary" id="btn-save">保存</button>
                </div>
            </div>
        </div>
    </div>

</div>
<!-- Content ends -->


<!-- JS -->
<script src="../js/jquery.js"></script> <!-- jQuery -->
<script src="../bootstrap-3.3.7-dist/js/bootstrap.js"></script> <!-- Bootstrap -->
<script src="../js/jquery-ui-1.9.2.custom.min.js"></script> <!-- jQuery UI -->
<script src="../js/util/pagenationJs.js"></script> <!-- Bootstrap -->
<script src="../js/bootstrap-combobox.js"></script> <!-- Bootstrap -->



<script src="../js/sparklines.js"></script> <!-- Sparklines -->
<script src="../js/jquery.cleditor.min.js"></script> <!-- CLEditor -->
<script src="../js/bootstrap-datetimepicker.min.js"></script> <!-- Date picker -->
<script src="../js/bootstrap-switch.min.js"></script> <!-- Bootstrap Toggle -->
<script src="../js/filter.js"></script> <!-- Filter for support page -->
<script src="../js/custom.js"></script> <!-- Custom codes -->
<script src="../js/charts.js"></script> <!-- Charts & Graphs -->

<script>

    var pageNum = 1;
    var pageSize = 10;
    var $paginationComponent;

    function dataLoad(q) {


        var url = "http://127.0.0.1:8095/menu/query";
        if (q !== '') {
            url += '?' + q;
        }

        document.getElementById("tb").innerHTML = "";
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: url,
            //数据，json字符串
            data: {
                pageSize: pageSize,
                pageNum: pageNum
            },
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var tableData = result.data;
                    var h = "";
                    for (var i = 0; i < tableData.length; i++) {
                        var dataObj = tableData[i];

                        var id = dataObj.id;
                        var menuName = dataObj.menuName;
                        var menuUrl = dataObj.menuUrl;
                        var groupMenu = dataObj.groupMenu;
                        var isGroup = dataObj.isGroup;
                        var description = dataObj.description;
                        var createDateStr = dataObj.createDateStr;
                        var sort = dataObj.sort;

                        h += "<tr>";
                        h += "<td>" + id + "</td>";
                        h += "<td>" + groupMenu + "</td>";
                        h += "<td>" + menuName + "</td>";
                        h += "<td>" + menuUrl + "</td>";
                        h += "<td>" + description + "</td>";
                        h += "<td>" + createDateStr + "</td>";
                        h += "<td>" + sort + "</td>";
                        h += "<td><a href=\"#updateModal\" class=\"btn btn-info\" data-toggle=\"modal\"  onclick=\"getDetail(" + id + ")\">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;" +
                            "<button type=\"button\" class=\"btn btn-primary\" onclick=\"deleteMenu(" + id + ")\" >删除</button></td>";
                        h += "</tr>";
                    }

                    document.getElementById("tb").innerHTML = h;
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };

    function deleteMenu(id) {
        $.ajax({
            //请求方式
            type: "PUT",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            async: false,
            //请求地址
            url: "http://127.0.0.1:8095/menu/delete",
            //数据，json字符串
            data: {
                userId: id
            },
            //请求成功
            success: function (result) {
                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    alert('操作成功');
                    dataLoad('');
                    $paginationComponent.reload()
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };

    function getDetail(id) {
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: "http://127.0.0.1:8095/menu/find/" + id,
            //数据，json字符串
//            data : list,
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var dataObj = result.data;

                    var id = dataObj.id;
                    var menuName = dataObj.menuName;
                    var menuUrl = dataObj.menuUrl;
                    var groupId = dataObj.groupId;
                    var groupName = dataObj.groupName;
                    var isGroup = dataObj.isGroup;
                    var description = dataObj.description;

                    var sort = dataObj.sort;


                    $("#id").val(id);
                    $("#menuName").val(menuName);
                    $("#menuUrl").val(menuUrl);
                    $("#groupName").val(groupName);
                    $("#description").val(description);
                    $("#sort").val(sort);


                    //todo 很麻烦的bootstrap select 赋初值
                    groupComboboxSetValue(groupId);
                    $("#myModal").modal('show');

                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };


    function getGroupList() {

        var url = "http://127.0.0.1:8095/group/findAll";
        document.getElementById("groupSelect").innerHTML = "";
        $.ajax({
            //请求方式
            type: "GET",
            //请求的媒体类型
            contentType: "application/x-www-form-urlencoded",
            //请求地址
            url: url,
            async: false,
            //请求成功
            success: function (result) {

                var code = result.code;
                var msg = result.msg;
                if (code === 1000) {
                    var tableData = result.data;
                    var h = "<option value='' selected='selected'></option>";

                    for (var i = 0; i < tableData.length; i++) {
                        var dataObj = tableData[i];

                        var id = dataObj.id;
                        var name = dataObj.name;

                        h += "<option value='"+id+"' >"+name+"("+id+")"+"</option>";
                    }

                    document.getElementById("groupSelect").innerHTML = h;
                } else {
                    alert(msg);
                    console.log(msg);
                }


            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        });
    };


    function groupComboboxSetValue(groupId){
        $("#groupSelect option").each(function () {
            var val = $(this).val();
            var text = $(this).text();
            $(this).removeAttr('selected',"selected");
//                        console.log(val+"    --------       "+text);
            if(val == groupId){
                $(this).attr('selected',"selected");
                $("#groupSelectTextBox").val(text);
            }
        });
    }

    $(function () {
        //todo 初始化分页组件
        $paginationComponent = new page(
            {
                id: 'paginationComponent',
                nowNum: 1,
                allNumUrl: "http://127.0.0.1:8095/menu/totalPage",
                isParam: false,
                pageSize: pageSize,
                dataMethod: 'dataLoad',
                queryForm: ['queryName', 'queryUserName'],
                callback: function (now, all) {
                    pageNum = now;
                }
            }
        );
        //todo 加载列表数据
        dataLoad('');

        //todo 定义添加功能
        var addGroup = function () {

            var sort = $("#sort").val();
            var groupName = $("#groupName").val();
            var description = $("#description").val();

            $.ajax({
                //请求方式
                type: "POST",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/menu/addGroup",
                //数据，json字符串
                data: {
                    sort: sort,
                    groupName: groupName,
                    description: description
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $paginationComponent.reload();
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };
        var addMenu = function () {
            var sort = $("#sort").val();
            var menuName = $("#menuName").val();
            var menuHref = $("#menuHref").val();
            var description = $("#description").val();

            var groupSelect = $("#groupSelect").val();
            if(groupSelect===""||groupSelect===null){
                alert("请选择菜单角色，分组不能为空！");
                return;
            }
            $.ajax({
                //请求方式
                type: "POST",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/user/addMenu",
                //数据，json字符串
                data: {
                    sort: sort,
                    menuName: menuName,
                    menuHref: menuHref,
                    description: description,
                    groupId: groupSelect
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $paginationComponent.reload();
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };
        //todo 定义修改功能
        var updateGroup = function () {

            var id = $("#id").val();
            var sort = $("#sort").val();
            var groupName = $("#groupName").val();
            var description = $("#description").val();
            $.ajax({
                //请求方式
                type: "PUT",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/menu/putGroup",
                //数据，json字符串
                data: {
                    id: id,
                    sort: sort,
                    groupName: groupName,
                    description: description
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };
        var updateMenu = function () {

            var id = $("#id").val();
            var sort = $("#sort").val();
            var menuName = $("#menuName").val();
            var menuHref = $("#menuHref").val();
            var description = $("#description").val();

            var groupSelect = $("#groupSelect").val();
            if(groupSelect===""||groupSelect===null){
                alert("请选择菜单角色，分组不能为空！");
                return;
            }
            $.ajax({
                //请求方式
                type: "PUT",
                //请求的媒体类型
                contentType: "application/x-www-form-urlencoded",
                async: false,
                //请求地址
                url: "http://127.0.0.1:8095/user/putMenu",
                //数据，json字符串
                data: {
                    id: id,
                    sort: sort,
                    menuName: menuName,
                    menuHref: menuHref,
                    description: description
                },
                //请求成功
                success: function (result) {
                    var code = result.code;
                    var msg = result.msg;
                    if (code === 1000) {
                        alert('操作成功');
                        dataLoad('');
                        $("#myModal").modal('hide');
                    } else {
                        alert(msg);
                        console.log(msg);
                    }


                },
                //请求失败，包含具体的错误信息
                error: function (e) {
                    console.log(e.status);
                    console.log(e.responseText);
                }
            });
        };

        //todo 点击保存账号按钮
        $('#btn-save').on('click', function (e) {
            $('#btn-save').prop('disabled', false);
            var id = $("#id").val();
            if(id === null||id ===''){
                var type = document.getElementsByName("menuType").value;
                if(type === "group"){
                  addGroup();
                }
                if(type === "menu"){
                 addMenu();
                }
            }else{
                var type = document.getElementsByName("menuType").value;
                if(type === "group") {
                    updateGroup();
                }
                if(type === "menu") {
                    updateMenu()
                }
            }
        });
        //todo 搜索按钮
        $("#btn-query").on('click', function (e) {
            var queryGroupName = $("#queryGroupName").val();
            var queryMenuName = $("#queryMenuName").val();

            var timestamp = Date.parse(new Date());
            var q = "ts=" + timestamp;

            if (queryGroupName !== '' && queryGroupName !== null){
                q += "&queryGroupName=" + queryGroupName;
            }
            if (queryMenuName !== '' && queryMenuName !== null){
                q += "&queryMenuName=" + queryMenuName;
            }

            if ((queryGroupName === '' || queryGroupName === null)&&(queryGroupName === ''|| queryGroupName === null)) {
                $paginationComponent.init(false);
            } else {
                $paginationComponent.init(true);
            }

//            initPagination(q);
            dataLoad(q);
        });

        //todo 界面调试按钮,测试辅助
        $("#btn-test").on('click',function (e){
            var groupSelect = $("#groupSelect").val();
            alert(groupSelect);
        });

        //todo 添加角色框监听打开关闭时间
        $('#myModal').on('show.bs.modal', function () {
            $('#btn-save').prop('disabled', false);
        });

        $('#myModal').on('hidden.bs.modal', function () {

            $("#id").val('');
            $("#menuName").val('');
            $("#menuUrl").val('');
            $("#groupName").val('');
            $("#description").val('');

            groupComboboxSetValue('');
        });

        //todo 获取下拉框数据（分组列表）
        getGroupList();
        //todo 初始化下拉框
        $('#groupSelect').combobox({bsVersion: '3',textId: 'groupSelectTextBox'});
    });

</script>
</body>
</html>